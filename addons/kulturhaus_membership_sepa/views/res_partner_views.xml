<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Add SEPA fields to partner form -->
    <record id="view_partner_form_sepa" model="ir.ui.view">
        <field name="name">res.partner.form.sepa</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_form"/>
        <field name="arch" type="xml">
            <notebook position="inside">
                <page string="SEPA Mandate" groups="base.group_user">
                    <group>
                        <group string="Bank Account">
                            <field name="bank_account_iban"/>
                            <field name="bank_account_bic"/>
                            <field name="bank_account_holder"/>
                        </group>
                        <group string="SEPA Mandate">
                            <field name="sepa_mandate_id"/>
                            <field name="sepa_mandate_date"/>
                            <field name="sepa_mandate_state"/>
                            <field name="sepa_last_debit_date"/>
                        </group>
                    </group>
                    <group>
                        <group string="Membership Payment">
                            <field name="membership_payment_method"/>
                            <field name="membership_period_preference"/>
                        </group>
                    </group>
                    <footer>
                        <button name="action_validate_mandate" string="Validate Mandate" 
                                type="object" class="btn-primary"
                                invisible="sepa_mandate_state == 'valid'"/>
                        <button name="action_cancel_mandate" string="Cancel Mandate" 
                                type="object" class="btn-secondary"
                                invisible="sepa_mandate_state != 'valid'"/>
                    </footer>
                </page>
            </notebook>
        </field>
    </record>

    <!-- Custom list view for SEPA members with specific fields -->
    <record id="view_partner_list_sepa_members" model="ir.ui.view">
        <field name="name">res.partner.list.sepa.members</field>
        <field name="model">res.partner</field>
        <field name="priority">100</field>
        <field name="arch" type="xml">
            <list string="Mitgliederliste">
                <!-- Always visible fields -->
                <field name="display_name" string="Name"/>
                <field name="email" string="E-Mail" optional="show"/>
                <field name="phone" string="Telefon" optional="hide"/>
                <field name="mobile" string="Mobil" optional="show"/>
                <field name="street" string="Adresse" optional="show"/>
                <field name="city" string="Stadt" optional="hide"/>
                <field name="membership_state" string="Status" 
                       widget="badge" 
                       decoration-success="membership_state == 'paid'" 
                       decoration-warning="membership_state == 'invoiced'" 
                       decoration-danger="membership_state in ['canceled', 'old']"
                       decoration-info="membership_state == 'free'"
                       optional="show"/>
                
                <!-- Optional fields (hidden by default, can be enabled) -->
                <field name="street2" string="Adresszusatz" optional="hide"/>
                <field name="zip" string="PLZ" optional="hide"/>
                <field name="state_id" string="Bundesland" optional="hide"/>
                <field name="country_id" string="Land" optional="hide"/>
                <field name="vat" string="USt-IdNr." optional="hide"/>
                <field name="website" string="Webseite" optional="hide"/>
                <field name="comment" string="Notizen" optional="hide"/>
                
                <!-- SEPA fields -->
                <field name="bank_account_iban" string="IBAN" optional="hide"/>
                <field name="bank_account_bic" string="BIC" optional="hide"/>
                <field name="sepa_mandate_id" string="Mandat-ID" optional="hide"/>
                <field name="sepa_mandate_state" string="SEPA-Status" optional="hide"/>
                <field name="sepa_last_debit_date" string="Letzte Lastschrift" optional="hide"/>
                
                <!-- Membership fields -->
                <field name="membership_start" string="Mitglied seit" optional="hide"/>
                <field name="membership_stop" string="Mitglied bis" optional="hide"/>
                <field name="membership_cancel" string="Kündigung" optional="hide"/>
                <field name="associate_member" string="Verknüpftes Mitglied" optional="hide"/>
                <field name="free_member" string="Freimitglied" optional="hide"/>
                <field name="membership_amount" string="Beitragshöhe" optional="hide"/>
                
                <!-- Additional contact fields -->
                <field name="function" string="Funktion" optional="hide"/>
                <field name="lang" string="Sprache" optional="hide"/>
                <field name="ref" string="Referenz" optional="hide"/>
                <field name="user_id" string="Verkäufer" optional="hide"/>
                <field name="company_id" string="Unternehmen" optional="hide"/>
                <field name="create_date" string="Erstellt am" optional="hide"/>
            </list>
        </field>
    </record>

    <!-- Enhanced search view with searchpanel - only for SEPA -->
    <record id="view_partner_search_sepa_enhanced" model="ir.ui.view">
        <field name="name">res.partner.search.sepa.enhanced</field>
        <field name="model">res.partner</field>
        <field name="priority">100</field>
        <field name="arch" type="xml">
            <search string="Mitglieder suchen">
                <!-- Search fields -->
                <field name="display_name" string="Name"/>
                <field name="email" string="E-Mail"/>
                <field name="phone" string="Telefon"/>
                <field name="mobile" string="Mobil"/>
                <field name="street" string="Adresse"/>
                <field name="city" string="Stadt"/>
                
                <!-- Filters -->
                <separator/>
                <filter string="Aktive" name="active" domain="[('active', '=', True)]"/>
                <filter string="Archiviert" name="inactive" domain="[('active', '=', False)]"/>
                <separator/>
                <filter string="Aktive Mitglieder" name="active_members" 
                        domain="[('membership_state', 'in', ['paid', 'invoiced', 'free'])]"/>
                <filter string="Bezahlt" name="paid" 
                        domain="[('membership_state', '=', 'paid')]"/>
                <filter string="In Rechnung" name="invoiced" 
                        domain="[('membership_state', '=', 'invoiced')]"/>
                <filter string="Freimitglied" name="free" 
                        domain="[('membership_state', '=', 'free')]"/>
                <separator/>
                <filter string="Gültiges SEPA-Mandat" name="sepa_valid" 
                        domain="[('sepa_mandate_state', '=', 'valid')]"/>
                <filter string="Kein SEPA-Mandat" name="no_sepa" 
                        domain="[('sepa_mandate_state', '!=', 'valid')]"/>
                
                <!-- Group By -->
                <group expand="0" string="Gruppieren nach">
                    <filter name="group_by_status" string="Mitgliedsstatus" 
                            context="{'group_by': 'membership_state'}"/>
                    <filter name="group_by_city" string="Stadt" 
                            context="{'group_by': 'city'}"/>
                    <filter name="group_by_sepa" string="SEPA-Status" 
                            context="{'group_by': 'sepa_mandate_state'}"/>
                </group>
                
                <!-- Search Panel - only with selection fields -->
                <searchpanel>
                    <field name="membership_state" string="Mitgliedsstatus" icon="fa-users" enable_counters="1"/>
                    <field name="sepa_mandate_state" string="SEPA-Status" icon="fa-credit-card" enable_counters="1"/>
                    <field name="country_id" string="Land" icon="fa-globe" select="multi" enable_counters="1"/>
                </searchpanel>
            </search>
        </field>
    </record>
</odoo>